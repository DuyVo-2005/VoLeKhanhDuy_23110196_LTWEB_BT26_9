<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Category CRUD</title>
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script
	src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="container mt-4">

	<h3>Category CRUD with AJAX - Duy Shop</h3>

	<!-- Form Thêm Mới -->
	<form id="addCategoryForm" enctype="multipart/form-data">
		<div class="mb-3">
			<label>Name</label> <input type="text" id="categoryName"
				class="form-control" required>
		</div>
		<div class="mb-3">
			<label>Icon</label> <input type="file" id="icon" class="form-control">
			<div id="preview" class="mt-2"></div>
		</div>
		<button type="submit" class="btn btn-primary">Add Category</button>
	</form>

	<hr>

	<!-- Bảng hiển thị -->
	<table class="table table-bordered" id="categoryTable">
		<thead>
			<tr>
				<th>ID</th>
				<th>Name</th>
				<th>Images</th>
				<th>Actions</th>
			</tr>
		</thead>
		<tbody></tbody>
	</table>

	<!-- Modal Edit Category -->
	<div class="modal fade" id="editCategoryModal" tabindex="-1"
		aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<form id="editCategoryForm" enctype="multipart/form-data">
					<div class="modal-header">
						<h5 class="modal-title">Edit Category</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
					</div>
					<div class="modal-body">
						<input type="hidden" id="editCategoryId"> <input
							type="hidden" id="editOldIcon">

						<div class="mb-3">
							<label>Name</label> <input type="text" id="editCategoryName"
								class="form-control" required>
						</div>
						<div class="mb-3">
							<label>Images</label> <input type="file" id="editIcon"
								class="form-control">
							<div id="editPreview" class="mt-2"></div>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary"
							data-bs-dismiss="modal">Cancel</button>
						<button type="submit" class="btn btn-primary">Save
							changes</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<script>
	const apiUrl = "http://localhost:8096/graphql";
	
	function loadCategories() {
	  $.ajax({
	    url: apiUrl,
	    type: "POST",
	    contentType: "application/json",
	    data: JSON.stringify({
	      query: `
	        query {
	          categories {
	            id
	            name
	            images
	          }
	        }
	      `
	    }),
	    success: function(res) {
	      let rows = "";
	      res.data.categories.forEach(cat => {
	        rows += `
	          <tr>
	            <td>${cat.id}</td>
	            <td>${cat.name}</td>
	            <td>${cat.images ? `<img src="/uploads/${cat.images}" width="50">` : ""}</td>
	            <td>
	              <button class="btn btn-sm btn-warning" onclick="editCategory(${cat.id})">Edit</button>
	              <button class="btn btn-sm btn-danger" onclick="deleteCategory(${cat.id})">Delete</button>
	            </td>
	          </tr>
	        `;
	      });
	      $("#categoryTable tbody").html(rows);
	    }
	  });
	}


	$("#addCategoryForm").submit(function(e) {
	  e.preventDefault();

	  const name = $("#categoryName").val();

	  $.ajax({
	    url: apiUrl,
	    type: "POST",
	    contentType: "application/json",
	    data: JSON.stringify({
	      query: `
	        mutation {
	          createCategory(name: "${name}") {
	            id
	            name
	          }
	        }
	      `
	    }),
	    success: function() {
	      alert("Thêm thành công!");
	      loadCategories();
	      $("#addCategoryForm")[0].reset();
	      $("#preview").html("");
	    }
	  });
	});

	function editCategory(id) {//Mở modal edit
	  $.ajax({
	    url: apiUrl,
	    type: "POST",
	    contentType: "application/json",
	    data: JSON.stringify({
	      query: `
	        query {
	          category(id: ${id}) {
	            id
	            name
	            images
	          }
	        }
	      `
	    }),
	    success: function(res) {
	      const cat = res.data.category;
	      $("#editCategoryId").val(cat.id);
	      $("#editCategoryName").val(cat.name);
	      $("#editOldIcon").val(cat.images || "");
	      $("#editPreview").html(cat.images ? `<img src="/uploads/${cat.images}" width="80">` : "");
	      new bootstrap.Modal(document.getElementById('editCategoryModal')).show();
	    }
	  });
	}

	$("#editCategoryForm").submit(function(e) {//Submit form Edit
	  e.preventDefault();

	  const id = $("#editCategoryId").val();
	  const name = $("#editCategoryName").val();

	  $.ajax({
	    url: apiUrl,
	    type: "POST",
	    contentType: "application/json",
	    data: JSON.stringify({
	      query: `
	        mutation {
	          updateCategory(id: ${id}, name: "${name}") {
	            id
	            name
	          }
	        }
	      `
	    }),
	    success: function() {
	      alert("Cập nhật thành công!");
	      loadCategories();
	      bootstrap.Modal.getInstance(document.getElementById('editCategoryModal')).hide();
	    }
	  });
	});

	function deleteCategory(id) {
	  if (confirm("Are you sure?")) {
	    $.ajax({
	      url: apiUrl,
	      type: "POST",
	      contentType: "application/json",
	      data: JSON.stringify({
	        query: `
	          mutation {
	            deleteCategory(id: ${id})
	          }
	        `
	      }),
	      success: function() {
	        alert("Xóa thành công!");
	        loadCategories();
	      }
	    });
	  }
	}

	loadCategories(); //Load khi page mở
</script>
</body>
</html>
