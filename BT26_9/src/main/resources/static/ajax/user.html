<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>User CRUD</title>
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script
	src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="container mt-4">

	<h3>User CRUD with AJAX - Duy Shop</h3>

	<!-- Form Thêm Mới -->
	<form id="addUserForm">
		<div class="mb-3">
			<label>Fullname</label> <input type="text" id="fullname"
				class="form-control" required>
		</div>
		<div class="mb-3">
			<label>Email</label> <input type="email" id="email"
				class="form-control" required>
		</div>
		<div class="mb-3">
			<label>Password</label> <input type="password" id="password"
				class="form-control" required>
		</div>
		<div class="mb-3">
			<label>Phone</label> <input type="text" id="phone"
				class="form-control">
		</div>
		<button type="submit" class="btn btn-primary">Add User</button>
	</form>

	<hr>

	<!-- Bảng hiển thị -->
	<table class="table table-bordered" id="userTable">
		<thead>
			<tr>
				<th>ID</th>
				<th>Fullname</th>
				<th>Email</th>
				<th>Phone</th>
				<th>Actions</th>
			</tr>
		</thead>
		<tbody></tbody>
	</table>

	<!-- Modal Edit User -->
	<div class="modal fade" id="editUserModal" tabindex="-1"
		aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<form id="editUserForm">
					<div class="modal-header">
						<h5 class="modal-title">Edit User</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
					</div>
					<div class="modal-body">
						<input type="hidden" id="editUserId">

						<div class="mb-3">
							<label>Fullname</label> <input type="text" id="editFullname"
								class="form-control" required>
						</div>
						<div class="mb-3">
							<label>Email</label> <input type="email" id="editEmail"
								class="form-control" required>
						</div>
						<div class="mb-3">
							<label>Password</label> <input type="password" id="editPassword"
								class="form-control" required>
						</div>
						<div class="mb-3">
							<label>Phone</label> <input type="text" id="editPhone"
								class="form-control">
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary"
							data-bs-dismiss="modal">Cancel</button>
						<button type="submit" class="btn btn-primary">Save
							changes</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<script>
const apiUrl = "http://localhost:8096/graphql";

function loadUsers() {
  $.ajax({
    url: apiUrl,
    type: "POST",
    contentType: "application/json",
    data: JSON.stringify({
      query: `
        query {
          users {
            id
            fullname
            email
            phone
          }
        }
      `
    }),
    success: function(res) {
      let rows = "";
      res.data.users.forEach(u => {
        rows += `
          <tr>
            <td>${u.id}</td>
            <td>${u.fullname}</td>
            <td>${u.email}</td>
            <td>${u.phone || ""}</td>
            <td>
              <button class="btn btn-sm btn-warning" onclick="editUser(${u.id})">Edit</button>
              <button class="btn btn-sm btn-danger" onclick="deleteUser(${u.id})">Delete</button>
            </td>
          </tr>
        `;
      });
      $("#userTable tbody").html(rows);
    }
  });
}

$("#addUserForm").submit(function(e) {
  e.preventDefault();

  const fullname = $("#fullname").val();
  const email = $("#email").val();
  const password = $("#password").val();
  const phone = $("#phone").val();

  $.ajax({
    url: apiUrl,
    type: "POST",
    contentType: "application/json",
    data: JSON.stringify({
      query: `
        mutation {
          createUser(fullname: "${fullname}", email: "${email}", password: "${password}", phone: "${phone}") {
            id
            fullname
          }
        }
      `
    }),
    success: function() {
      alert("Thêm thành công!");
      loadUsers();
      $("#addUserForm")[0].reset();
    }
  });
});

function editUser(id) {
  $.ajax({
    url: apiUrl,
    type: "POST",
    contentType: "application/json",
    data: JSON.stringify({
      query: `
        query {
          findUserById(id: ${id}) {
            id
            fullname
            email
            password
            phone
          }
        }
      `
    }),
    success: function(res) {
      const u = res.data.findUserById;
      $("#editUserId").val(u.id);
      $("#editFullname").val(u.fullname);
      $("#editEmail").val(u.email);
      $("#editPassword").val(u.password);
      $("#editPhone").val(u.phone || "");
      new bootstrap.Modal(document.getElementById('editUserModal')).show();
    }
  });
}

$("#editUserForm").submit(function(e) {
  e.preventDefault();

  const id = $("#editUserId").val();
  const fullname = $("#editFullname").val();
  const email = $("#editEmail").val();
  const password = $("#editPassword").val();
  const phone = $("#editPhone").val();

  $.ajax({
    url: apiUrl,
    type: "POST",
    contentType: "application/json",
    data: JSON.stringify({
      query: `
        mutation {
          updateUser(id: ${id}, fullname: "${fullname}", email: "${email}", password: "${password}", phone: "${phone}") {
            id
            fullname
          }
        }
      `
    }),
    success: function() {
      alert("Cập nhật thành công!");
      loadUsers();
      bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
    }
  });
});

function deleteUser(id) {
  if (confirm("Are you sure?")) {
    $.ajax({
      url: apiUrl,
      type: "POST",
      contentType: "application/json",
      data: JSON.stringify({
        query: `
          mutation {
            deleteUser(id: ${id})
          }
        `
      }),
      success: function() {
        alert("Xóa thành công!");
        loadUsers();
      }
    });
  }
}

loadUsers();//load khi mở page
</script>
</body>
</html>
